#!/usr/bin/env bash
# ShiftLefter CLI wrapper (release distribution)
#
# This script is bundled with the ShiftLefter release zip.
# It expects a shiftlefter*.jar file in the same directory.
#
# Installation:
#   1. Unzip the release archive
#   2. Add the unzipped directory to your PATH
#   3. Run: sl --help

set -euo pipefail

# Capture user's working directory BEFORE any cd operations
# This is passed to Clojure so relative paths resolve correctly
USER_CWD="$PWD"
export SL_USER_CWD="$USER_CWD"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Find the JAR file in the same directory as this script
find_jar() {
    local jar
    jar=$(ls "$SCRIPT_DIR"/shiftlefter*.jar 2>/dev/null | head -1)
    if [[ -n "$jar" && -f "$jar" ]]; then
        echo "$jar"
    else
        echo ""
    fi
}

# Find Java executable, checking common locations
find_java() {
    # 1. Check JAVA_HOME (explicit user preference)
    if [[ -n "${JAVA_HOME:-}" ]] && [[ -x "$JAVA_HOME/bin/java" ]]; then
        echo "$JAVA_HOME/bin/java"
        return
    fi

    # 2. Check homebrew openjdk (common on macOS with Apple Silicon)
    local brew_java="/opt/homebrew/opt/openjdk/libexec/openjdk.jdk/Contents/Home/bin/java"
    if [[ -x "$brew_java" ]]; then
        echo "$brew_java"
        return
    fi

    # 3. Check homebrew openjdk on Intel Mac
    local brew_java_intel="/usr/local/opt/openjdk/libexec/openjdk.jdk/Contents/Home/bin/java"
    if [[ -x "$brew_java_intel" ]]; then
        echo "$brew_java_intel"
        return
    fi

    # 4. Check java_home helper (macOS system Java)
    if [[ -x /usr/libexec/java_home ]] && /usr/libexec/java_home &>/dev/null 2>&1; then
        echo "$(/usr/libexec/java_home)/bin/java"
        return
    fi

    # 5. Check PATH (verify it actually works)
    if command -v java &>/dev/null; then
        local java_path
        java_path=$(command -v java)
        if "$java_path" -version &>/dev/null 2>&1; then
            echo "$java_path"
            return
        fi
    fi

    # No working Java found
    echo ""
}

# Handle `sl repl` command - requires clj (Clojure CLI)
# This is handled in shell because we need to launch clj, not java -jar
handle_repl_cmd() {
    local nrepl_mode=false
    local nrepl_port=""

    # Parse repl-specific args
    shift  # remove "repl"
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --nrepl)
                nrepl_mode=true
                shift
                ;;
            --port)
                nrepl_port="$2"
                shift 2
                ;;
            --help|-h)
                echo "Usage: sl repl [--nrepl] [--port PORT]"
                echo ""
                echo "Start a Clojure REPL with ShiftLefter loaded."
                echo ""
                echo "Options:"
                echo "  --nrepl       Start an nREPL server (for IDE integration)"
                echo "  --port PORT   nREPL port (default: auto-select, printed on startup)"
                echo ""
                echo "IDE Integration (VS Code/Calva, Emacs/CIDER):"
                echo "  1. Run: sl repl --nrepl"
                echo "  2. Note the port number printed"
                echo "  3. In your IDE, 'Connect to running REPL' on that port"
                echo ""
                echo "If you have a deps.edn in the current directory, your dependencies"
                echo "will be merged with ShiftLefter automatically."
                echo ""
                echo "Requires: Clojure CLI (clj) installed"
                exit 0
                ;;
            *)
                echo "Unknown option: $1" >&2
                echo "Use 'sl repl --help' for usage" >&2
                exit 1
                ;;
        esac
    done

    # Check for clj
    if ! command -v clj &>/dev/null; then
        echo "Error: Clojure CLI (clj) not found." >&2
        echo "" >&2
        echo "The 'sl repl' command requires Clojure CLI. Install options:" >&2
        echo "  macOS:   brew install clojure/tools/clojure" >&2
        echo "  Ubuntu:  See https://clojure.org/guides/install_clojure" >&2
        echo "  Windows: See https://clojure.org/guides/install_clojure" >&2
        echo "" >&2
        echo "Other sl commands (run, fmt, etc.) only require Java." >&2
        exit 1
    fi

    # Find JAR for classpath
    JAR_FILE=$(find_jar)
    if [[ -z "$JAR_FILE" ]]; then
        echo "Error: ShiftLefter JAR not found in $SCRIPT_DIR" >&2
        exit 1
    fi

    # Build the deps map - always include shiftlefter JAR
    local sl_dep="{:deps {shiftlefter/shiftlefter {:local/root \"$JAR_FILE\"}"

    # Add nREPL deps if needed
    if [[ "$nrepl_mode" == "true" ]]; then
        sl_dep="$sl_dep nrepl/nrepl {:mvn/version \"1.0.0\"} cider/cider-nrepl {:mvn/version \"0.28.5\"}"
    fi

    sl_dep="$sl_dep}}"

    # Check if user has deps.edn - if so, merge with it
    local clj_args=()
    if [[ -f "deps.edn" ]]; then
        # User has deps.edn - use Sdeps to add our deps on top
        clj_args+=("-Sdeps" "$sl_dep")
    else
        # No user deps.edn - just use our deps directly
        clj_args+=("-Sdeps" "$sl_dep")
    fi

    if [[ "$nrepl_mode" == "true" ]]; then
        # Start nREPL server
        local port_args=()
        if [[ -n "$nrepl_port" ]]; then
            port_args=("--port" "$nrepl_port")
        fi

        echo "Starting nREPL server with ShiftLefter..."
        exec clj "${clj_args[@]}" \
            -M -m nrepl.cmdline \
            --middleware "[cider.nrepl/cider-middleware]" \
            "${port_args[@]}"
    else
        # Interactive REPL
        echo "Starting ShiftLefter REPL..."
        echo "Try: (require '[shiftlefter.repl :refer :all])"
        echo ""
        exec clj "${clj_args[@]}"
    fi
}

# Main dispatch
# Check for repl command BEFORE looking for JAR (repl uses clj, not java -jar)
if [[ "${1:-}" == "repl" ]]; then
    handle_repl_cmd "$@"
fi

JAR_FILE=$(find_jar)
if [[ -z "$JAR_FILE" ]]; then
    echo "Error: ShiftLefter JAR not found in $SCRIPT_DIR" >&2
    echo "" >&2
    echo "Expected a file matching: shiftlefter*.jar" >&2
    echo "" >&2
    echo "If you downloaded only the JAR file, place it in the same directory" >&2
    echo "as this script, or download the full release zip from:" >&2
    echo "  https://github.com/shiftlefter/shiftlefter/releases" >&2
    exit 1
fi

JAVA_CMD=$(find_java)
if [[ -z "$JAVA_CMD" ]]; then
    echo "Error: Java not found." >&2
    echo "" >&2
    echo "ShiftLefter requires Java 11 or later. Install options:" >&2
    echo "  macOS:   brew install openjdk" >&2
    echo "  Ubuntu:  sudo apt install openjdk-17-jdk" >&2
    echo "  Windows: Download from https://adoptium.net/" >&2
    exit 1
fi

exec "$JAVA_CMD" -jar "$JAR_FILE" "$@"
